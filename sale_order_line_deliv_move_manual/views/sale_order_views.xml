<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <record id="view_order_tree" model="ir.ui.view">
        <field name="name">
            sale.order.tree (in sale_order_line_deliv_move_manual)
        </field>
        <field name="model">sale.order</field>
        <field name="inherit_id" ref="sale.view_order_tree" />
        <field name="arch" type="xml">
            <xpath expr="//tree" position="attributes">
                <attribute name="decoration-danger">
                    has_pend_qty_delivered_dest==True
                </attribute>
            </xpath>
            <xpath expr="//tree" position="inside">
                <field name="has_pend_qty_delivered_dest" invisible="1"/>
            </xpath>
        </field>
    </record>

    <record id="view_order_form" model="ir.ui.view">
        <field name="name">sale.order.form (in sale_order_line_deliv_move_manual)</field>
        <field name="model">sale.order</field>
        <field name="inherit_id" ref="sale.view_order_form" />
        <field name="arch" type="xml">
            <xpath
                expr="//field[@name='order_line']//form//div[@name='delivered_qty']"
                position="after"
            >
                <field name="product_invoice_policy" invisible="1"/>
                <label
                    for="qty_delivered_dest"
                    string="On destination"
                    attrs="{'invisible': [
                        '|',
                        ('parent.state', 'not in', ['sale', 'done']),
                        ('product_invoice_policy', '!=', 'stock_move_dest'),
                    ]}"
                />
                <div
                    name="dest_delivered_qty"
                    attrs="{'invisible': [
                        '|',
                        ('parent.state', 'not in', ['sale', 'done']),
                        ('product_invoice_policy', '!=', 'stock_move_dest'),
                    ]}"
                >
                    <field name="qty_delivered_dest"/>
                </div>
            </xpath>
            <xpath
                expr="//field[@name='order_line']//tree//field[@name='qty_delivered']"
                position="after"
            >
                <field
                    name="qty_delivered_dest" 
                    string="Dest."
                    attrs="{
                        'column_invisible': [('parent.state', 'not in', ['sale', 'done'])],
                    }"                    
                    optional="show"
                />
            </xpath>
        </field>
    </record>

    <record id="sale_order_view_search_inherit_sale" model="ir.ui.view">
        <field name="name">
            sale.order.search.inherit.sale (in sale_order_line_deliv_move_manual)
        </field>
        <field name="model">sale.order</field>
        <field name="inherit_id" ref="sale.sale_order_view_search_inherit_sale" />
        <field name="arch" type="xml">
            <filter name="my_sale_orders_filter" position="after">
                <separator/>
                <filter
                    name="has_pend_qty_delivered_dest_filter"
                    string="Has Pending Destination Quantities"
                    domain="[('has_pend_qty_delivered_dest','=',True)]"
                />
            </filter>
        </field>
    </record>

</odoo>
